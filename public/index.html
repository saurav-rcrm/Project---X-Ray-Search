<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Sourcer</title>
<link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
<link rel="icon" type="ico" href="favicon.ico" sizes="32x32" />
<style>
*{box-sizing:border-box}
body{font-family:'Roboto',sans-serif;margin:0;padding:0;background:#f4f7f9;color:#333}
header{background:#007bff;color:#fff;padding:15px 20px;text-align:center}
.container{max-width:2000px;margin:20px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.search-mode{margin-bottom:20px}
.toggle-group{margin-bottom:15px}
.toggle-group label{margin-right:20px;cursor:pointer;font-weight:500}
.input-group{margin-bottom:15px;display:none;flex-wrap:wrap;gap:15px}
.input-group.active{display:flex;flex-direction:column}
.input-group.non-ai{flex-direction:row;flex-wrap:wrap;justify-content:space-between}
.input-group.non-ai .field{display:flex;flex-direction:column;width:48%}
.input-group textarea,.input-group input,.input-group select{padding:10px;font-size:1rem;border:1px solid #ccc;border-radius:5px;width:100%}
.btn-container{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.btn-group-left{display:flex;gap:10px;align-items:center}
button{padding:12px 25px;font-size:1rem;border:none;border-radius:5px;cursor:pointer;background:#007bff;color:#fff;transition:background .3s ease}
button:disabled{background:#999;cursor:not-allowed}
button:hover:not(:disabled){background:#0056b3}
.shortcut-hint{font-size:.9rem;color:#666;margin-left:5px}
#progressBarContainer{position:relative;width:150px;height:20px;background:#eee;border-radius:10px;overflow:hidden;display:none}
#progressBar{height:100%;width:0;background:#007bff;transition:width .3s ease;text-align:center;color:#fff;line-height:20px;font-size:.8rem}
#loadingContainer{display:none;text-align:right;margin-top:5px}
#loadingMessage{font-size:.9rem;color:#555;display:inline-block;margin-left:5px}
.spinner{display:inline-block;width:24px;height:24px;border:4px solid #f3f3f3;border-top:4px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle}
.spinner.small{width:18px;height:18px;border-width:3px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#results{margin-top:30px}
.loader{text-align:center;font-size:1.2rem;color:#555}
table{width:100%;border-collapse:collapse;margin-bottom:20px}
table th,table td{padding:12px 15px;border:1px solid #ddd;text-align:left;vertical-align:middle}
table th{background:#007bff;color:#fff;font-weight:500}
table td img{width:60px;height:60px;border-radius:50%;object-fit:cover}
table a{color:#007bff;text-decoration:none}
table a:hover{text-decoration:underline}
/* highlight */
.highlight{background:#dfbf8aec}
</style>
</head>
<body>
<header><h1>AI Candidate Sourcer</h1><p>Discover Top Talent Using the Power of AI and X-Ray Search</p></header>

<div class="container">
  <!-- SEARCH MODE & INPUTS -->
  <div class="search-mode">
    <div class="toggle-group">
      <label><input type="radio" name="searchMode" value="non-ai" /> Traditional Keyword Search</label>
      <label><input type="radio" name="searchMode" value="ai" checked/> AI Search</label>
    </div>

    <!-- Traditional inputs (hidden by default) -->
    <div class="input-group non-ai" id="nonAiInputs" style="display:none;">
      <div class="field"><label for="country">Country:</label>
        <select id="country">
          <option value="">Select a country</option>
          <!-- country list trimmed -->
          <option value="United States">United States</option><option value="India">India</option>
        </select>
      </div>
      <div class="field"><label for="jobTitle">Job Title:</label><input type="text" id="jobTitle" placeholder="e.g., Product Manager"/></div>
      <div class="field"><label for="includeKeywords">Keywords to Include:</label><input type="text" id="includeKeywords" placeholder="e.g., Fintech, B2B"/></div>
      <div class="field"><label for="excludeKeywords">Keywords to Exclude:</label><input type="text" id="excludeKeywords" placeholder="e.g., Internship, Entry-level"/></div>
      <div class="field"><label for="currentEmployer">Current Employer:</label><input type="text" id="currentEmployer" placeholder="e.g., Microsoft"/></div>
    </div>

    <!-- AI textarea (visible by default) -->
    <div class="input-group ai active" id="aiInput" style="display:block;">
      <label for="aiJobDescription">Job Description / Candidate Requirements:</label>
      <textarea id="aiJobDescription" placeholder="e.g., Describe the role and requirements..."></textarea>
    </div>

    <div class="btn-container">
      <div class="btn-group-left">
        <button id="findCandidatesBtn" disabled>Find Candidates <span id="shortcutHint" class="shortcut-hint"></span></button>
        <button id="cancelBtn" style="display:none;">Cancel</button>
      </div>
      <div>
        <div id="progressBarContainer"><div id="progressBar">0%</div></div>
        <div id="loadingContainer"><div class="spinner"></div><span id="loadingMessage">Loading candidates</span></div>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results"><div class="loader">Let's Find the Purple Squirrel</div></div>
</div>

<script>
/* ----------  GLOBALS ---------- */
let abortController=null;
const findBtn      =document.getElementById('findCandidatesBtn');
const cancelBtn    =document.getElementById('cancelBtn');
const resultsDiv   =document.getElementById('results');
const progressWrap =document.getElementById('progressBarContainer');
const progressBar  =document.getElementById('progressBar');
const loadingWrap  =document.getElementById('loadingContainer');
const loadingMsg   =document.getElementById('loadingMessage');
let highlightTerms=[];


/* ----------  UTILITIES ---------- */
const escapeRegExp=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
const isMac=/Mac|iPod|iPhone|iPad/.test(navigator.platform);
document.getElementById('shortcutHint').textContent=isMac?'⌘+Enter':'Ctrl+Enter';

/* “Preferred Company:” prefix helper */
const prefix="Preferred Company: ";
const currentEmployerInput=document.getElementById('currentEmployer');
currentEmployerInput.addEventListener('input',()=>{
  let v=currentEmployerInput.value.trim();
  if(v.toLowerCase().startsWith(prefix.toLowerCase())) v=v.slice(prefix.length).trim();
  if(v!=="") currentEmployerInput.value=prefix+v;
});

/* Enable / disable search button */
function checkInput(){
  const mode=document.querySelector('input[name="searchMode"]:checked').value;
  const ok=(mode==='non-ai')
           ?(document.getElementById('jobTitle').value.trim()||document.getElementById('includeKeywords').value.trim())
           :document.getElementById('aiJobDescription').value.trim();
  findBtn.disabled=!ok;
}
document.querySelectorAll('input,textarea,select').forEach(el=>el.addEventListener('input',checkInput));
checkInput();

/* Toggle groups */
document.getElementsByName('searchMode').forEach(radio=>{
  radio.addEventListener('change',()=>{
    document.getElementById('nonAiInputs').style.display=radio.value==='non-ai'&&radio.checked?'flex':'none';
    document.getElementById('aiInput'   ).style.display=radio.value==='ai'   &&radio.checked?'block':'none';
    checkInput();
  });
});

/* Country ➜ LinkedIn domain (trimmed list) */
const countryDomainMapping={"india":"in.linkedin.com","united states":"www.linkedin.com","united kingdom":"uk.linkedin.com"};
const getLinkedInDomain=t=>{
  if(!t) return null;
  t=t.toLowerCase();
  for(const c in countryDomainMapping) if(t.includes(c)) return countryDomainMapping[c];
  return null;
};

/* Extract quoted or OR-grouped terms */
function parseQueryTerms(str){
  const terms=[];
  if(!str) return terms;
  const quoteRE=/["']([^"']+)["']/g, parenRE=/\(([^()]+)\)/g;
  let m;
  while((m=quoteRE.exec(str))) terms.push(...m[1].split(/\s+/));
  while((m=parenRE.exec(str)))  m[1].split(/\s+OR\s+/i).forEach(t=>terms.push(t));
  return terms
    .map(t=>t.trim())
    .filter(t=>t && !/^site:/i.test(t) && !['AND','OR','NOT'].includes(t.toUpperCase()))
    .map(t=>t.toLowerCase());
}

/* --------- HIGHLIGHTING --------- */
function highlightKeywords(container){
  if(!highlightTerms.length) return;
  const re=new RegExp('\\b('+highlightTerms.map(escapeRegExp).join('|')+')\\b','gi');
  const walker=document.createTreeWalker(container,NodeFilter.SHOW_TEXT,null,false);
  const nodes=[];
  while(walker.nextNode()) nodes.push(walker.currentNode);
  nodes.forEach(n=>{
    if(n.parentNode.classList && n.parentNode.classList.contains('highlight')) return;
    if(re.test(n.data)){
      const wrap=document.createElement('span');
      wrap.innerHTML=n.data.replace(re,'<span class="highlight">$1</span>');
      n.parentNode.replaceChild(wrap,n);
    }
  });
}

/* --------- TABLE LOADER --------- */
function addTableLoader(){
  const tbody=resultsDiv.querySelector('table tbody');
  if(!tbody) return;
  if(tbody.querySelector('.table-loader')) return;
  const colSpan=tbody.parentElement.querySelectorAll('th').length||5;
  const tr=document.createElement('tr');tr.className='table-loader';
  const td=document.createElement('td');td.colSpan=colSpan;td.style.textAlign='center';
  td.innerHTML='<div class="spinner small"></div> Loading more candidates...';
  tr.appendChild(td);tbody.appendChild(tr);
}
function removeTableLoader(){
  const row=resultsDiv.querySelector('.table-loader');
  if(row) row.remove();
}

/* --------- STREAM FETCH --------- */
async function fetchCandidatesStreaming(payload){
  resultsDiv.innerHTML="<div class='loader'>Loading candidate data...</div>";
  progressWrap.style.display='block';progressBar.style.width='0%';progressBar.textContent='0%';
  loadingWrap.style.display='block';loadingMsg.textContent='Loading candidates';
  cancelBtn.style.display='inline-block';findBtn.disabled=true;
  abortController=new AbortController();

  try{
    const res=await fetch('/api/process-job',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload),signal:abortController.signal
    });
    const reader=res.body.getReader();const decoder=new TextDecoder();let stream="";
    while(true){
      const {done,value}=await reader.read();if(done) break;
      stream+=decoder.decode(value,{stream:true});
      resultsDiv.innerHTML=stream;
      highlightKeywords(resultsDiv);    /* real-time highlight  */
      addTableLoader();                 /* show table loader   */
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
      const rows=resultsDiv.querySelectorAll('tbody tr').length;
      const pct=Math.min(rows/10*100,100);
      progressBar.style.width=pct+'%';progressBar.textContent=Math.round(pct)+'%';
    }
    removeTableLoader();                /* finished */
  }catch(err){
    const cancelled=err.name==='AbortError';
    resultsDiv.innerHTML=`<p>${cancelled?'Candidate search canceled.':'Error fetching candidate data.'}</p>`;
    loadingMsg.textContent=cancelled?'Search canceled.':'Error fetching data.';
    progressBar.style.width='0%';progressBar.textContent='0%';
  }finally{
    cancelBtn.style.display='none';abortController=null;checkInput();
    setTimeout(()=>{progressWrap.style.display='none';loadingWrap.style.display='none'},1000);
  }
}

/* --------- MAIN HANDLER --------- */
async function handleFindCandidates(){
  const mode=document.querySelector('input[name="searchMode"]:checked').value;
  const payload={};

  if(mode==='non-ai'){
    const country=document.getElementById('country').value.trim();
    const jobTitle=document.getElementById('jobTitle').value;
    const incKW=document.getElementById('includeKeywords').value;
    const excKW=document.getElementById('excludeKeywords').value;
    const employer=document.getElementById('currentEmployer').value;

    let domain=country?getLinkedInDomain(country):null;
    if(!domain) domain=getLinkedInDomain(jobTitle)||getLinkedInDomain(incKW)||"linkedin.com";

    payload.jobDescription=`site:${domain}/in/ AND "${jobTitle}" AND "${incKW}" ${excKW?" -'"+excKW+"'":""} ${employer||""}`;
    highlightTerms=[...new Set([...parseQueryTerms(payload.jobDescription),...incKW.split(/[,;\s]+/).map(t=>t.toLowerCase())])];
  }else{
    payload.jobDescription=document.getElementById('aiJobDescription').value;
    const words=[...new Set(payload.jobDescription.split(/\W+/).filter(w=>w.length>3))];
    highlightTerms=words.slice(0,10).map(w=>w.toLowerCase());
  }

  await fetchCandidatesStreaming(payload);
}

/* --------- EVENTS --------- */
findBtn.addEventListener('click',handleFindCandidates);
document.addEventListener('keydown',e=>{
  if(((isMac&&e.metaKey)||(!isMac&&e.ctrlKey))&&e.key==='Enter'&&!findBtn.disabled) handleFindCandidates();
});
cancelBtn.addEventListener('click',()=>abortController&&abortController.abort());
</script>
</body>
</html>