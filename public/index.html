<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>X-Ray Search</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f7f9;
      color: #333;
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 15px 20px;
      text-align: center;
    }
    .container {
      max-width: 2000px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .search-mode {
      margin-bottom: 20px;
    }
    .toggle-group {
      margin-bottom: 15px;
    }
    .toggle-group label {
      margin-right: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .input-group {
      margin-bottom: 15px;
      display: none;
      flex-wrap: wrap;
      gap: 15px;
    }
    .input-group.active {
      display: flex;
      flex-direction: column;
    }
    .input-group.non-ai {
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .input-group.non-ai .field {
      display: flex;
      flex-direction: column;
      width: 48%;
    }
    .input-group textarea,
    .input-group input {
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
    }
    .btn-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button {
      padding: 12px 25px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #007bff;
      color: #fff;
      margin-top: 10px;
      transition: background 0.3s ease;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #0056b3;
    }
    .shortcut-hint {
      font-size: 0.9rem;
      color: #666;
      margin-left: 5px;
    }
    #results {
      margin-top: 30px;
      overflow-x: auto;
    }
    .loader {
      text-align: center;
      font-size: 1.2rem;
      color: #555;
    }
    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table th,
    table td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    table th {
      background: #007bff;
      color: #fff;
      font-weight: 500;
    }
    table td img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
    }
    table a {
      color: #007bff;
      text-decoration: none;
    }
    table a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>X-Ray Search</h1>
    <p>built by Saurav</p>
  </header>
  <div class="container">
    <!-- Search Mode Toggle & Input Fields -->
    <div class="search-mode">
      <div class="toggle-group">
        <label>
          <input type="radio" name="searchMode" value="non-ai" checked />
          Traditional Keyword Search
        </label>
        <label>
          <input type="radio" name="searchMode" value="ai" />
          AI Search
        </label>
      </div>
      <!-- Non-AI Fields -->
      <div class="input-group non-ai active" id="nonAiInputs">
        <div class="field">
          <label for="country">Country:</label>
          <input type="text" id="country" placeholder="e.g., USA" />
        </div>
        <div class="field">
          <label for="jobTitle">Job Title:</label>
          <input type="text" id="jobTitle" placeholder="e.g., Product Manager" />
        </div>
        <div class="field">
          <label for="includeKeywords">Keywords to Include:</label>
          <input type="text" id="includeKeywords" placeholder="e.g., Fintech, B2B" />
        </div>
        <div class="field">
          <label for="excludeKeywords">Keywords to Exclude:</label>
          <input type="text" id="excludeKeywords" placeholder="e.g., Internship, Entry-level" />
        </div>
        <div class="field">
          <label for="currentEmployer">Current Employer:</label>
          <input type="text" id="currentEmployer" placeholder="e.g., Microsoft" />
        </div>
      </div>
      <!-- AI Search Field -->
      <div class="input-group ai" id="aiInput">
        <label for="aiJobDescription">Job Description / Candidate Requirements:</label>
        <textarea id="aiJobDescription" placeholder="e.g., Describe the role and requirements..."></textarea>
      </div>
      <div class="btn-container">
        <button id="findCandidatesBtn" disabled>Find Candidates <span id="shortcutHint" class="shortcut-hint"></span></button>
        <button id="cancelBtn" style="display:none;">Cancel</button>
      </div>
    </div>

    <!-- Results -->
    <div id="results">
      <div class="loader">I'm here to source candidates for you :)</div>
    </div>
  </div>

  <script>
    let abortController = null;
    const findBtn = document.getElementById('findCandidatesBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const resultsDiv = document.getElementById('results');

    // Function to detect OS and set shortcut hint text
    function setShortcutHint() {
      const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
      const hintText = isMac ? 'âŒ˜+Enter' : 'Ctrl+Enter';
      document.getElementById('shortcutHint').textContent = hintText;
    }
    setShortcutHint();

    // Function to check if input is empty and disable button accordingly
    function checkInput() {
      const mode = document.querySelector('input[name="searchMode"]:checked').value;
      let input;
      if (mode === 'non-ai') {
        // Check non-AI fields (you may decide to check one or combine multiple)
        input = document.getElementById('jobTitle').value.trim() ||
                document.getElementById('includeKeywords').value.trim();
      } else {
        input = document.getElementById('aiJobDescription').value.trim();
      }
      findBtn.disabled = !input;
    }

    // Add event listeners to input fields to enable/disable the Find button
    document.querySelectorAll('input, textarea').forEach(inputElem => {
      inputElem.addEventListener('input', checkInput);
    });
    checkInput(); // initial check

    // Toggle search mode between Non-AI and AI
    const searchModeRadios = document.getElementsByName('searchMode');
    const nonAiInputs = document.getElementById('nonAiInputs');
    const aiInput = document.getElementById('aiInput');

    searchModeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'non-ai' && radio.checked) {
          nonAiInputs.style.display = 'flex';
          nonAiInputs.classList.add('active');
          aiInput.style.display = 'none';
        } else if (radio.value === 'ai' && radio.checked) {
          nonAiInputs.style.display = 'none';
          aiInput.style.display = 'block';
        }
        checkInput();
      });
    });

    // Function to stream candidate data from the server and update the results container progressively
    async function fetchCandidatesStreaming(payload) {
      resultsDiv.innerHTML = "<div class='loader'>Loading candidate data...</div>";
      abortController = new AbortController();
      cancelBtn.style.display = 'inline-block';
      findBtn.disabled = true;
      try {
        const response = await fetch('/api/process-job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: abortController.signal
        });
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let htmlStream = "";
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          htmlStream += decoder.decode(value, { stream: true });
          resultsDiv.innerHTML = htmlStream;
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          resultsDiv.innerHTML = "<p>Candidate search canceled.</p>";
        } else {
          console.error("Error fetching candidate data:", error);
          resultsDiv.innerHTML = "<p>Error fetching candidate data.</p>";
        }
      } finally {
        cancelBtn.style.display = 'none';
        abortController = null;
        checkInput(); // re-enable button if input is present
      }
    }

    // Handler for "Find Candidates" button
    async function handleFindCandidates() {
      let payload = {};
      const mode = document.querySelector('input[name="searchMode"]:checked').value;
      if (mode === 'non-ai') {
        const country = document.getElementById('country').value;
        const jobTitle = document.getElementById('jobTitle').value;
        const includeKeywords = document.getElementById('includeKeywords').value;
        const excludeKeywords = document.getElementById('excludeKeywords').value;
        const currentEmployer = document.getElementById('currentEmployer').value;
        payload.jobDescription = `site:linkedin.com/in/ AND '${jobTitle}' AND '${includeKeywords}' ${excludeKeywords ? " -'" + excludeKeywords + "'" : ""} ${country ? country : ""} ${currentEmployer ? currentEmployer : ""}`;
      } else {
        payload.jobDescription = document.getElementById('aiJobDescription').value;
      }
      await fetchCandidatesStreaming(payload);
    }

    findBtn.addEventListener('click', handleFindCandidates);

    // Add keyboard shortcut (Cmd+Enter on macOS, Ctrl+Enter on Windows)
    document.addEventListener('keydown', (event) => {
      const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
      if ((isMac && event.metaKey && event.key === 'Enter') ||
          (!isMac && event.ctrlKey && event.key === 'Enter')) {
        // Only trigger if button is enabled
        if (!findBtn.disabled) {
          handleFindCandidates();
        }
      }
    });

    // Cancel button event
    cancelBtn.addEventListener('click', () => {
      if (abortController) {
        abortController.abort();
      }
    });
  </script>
</body>
</html>